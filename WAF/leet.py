import urllib
import cgi
import MySQLdb

class check:
    id=''
    len = 0
    # length of string
    check_list = []
    #The_black_list_of_check
    token=''
    cookie=''
    data=''
    database=None
    find =0

    def __init__(self,check_list):
        self.check_list =check_list
        self.database=None

                #When the function return -1 the request must be down
    def input_data(self,data):
        self.data = data

    def getcookie(self,cookie):
        self.cookie = cookie
        mid=cookie.split('user=',1)[1]
        self.id=mid.split(';',1)[0]
        if 'token' in cookie:
            coo = cookie.split('token=',1)[1]
            self.token = coo.split('\r\n',1)[0]
            return 1
        else:
            if 'main.php' in self.data:
                return -1
            else:
                return 1


    def tokencheck(self):
        db = MySQLdb.connect("localhost", "root", "", "netsec", charset='utf8')
        cursor = db.cursor()
        cursor.execute("SELECT * from tokenlist")
        result = cursor.fetchall()
        for i in result:
            if self.token==i[1] and self.id==i[0]:
                return 1
        return -1
        
    def check_sqli(self):
        url = urllib.unquote(self.data)
        url = url.replace('?',':')
        print (url)
        tmp=url.split('\n')
        if(url[0]=='P' or url[0]=='G'):
            tmp[-1]=':'+tmp[-1]
        for testl in tmp:
            flag=testl.split(':')
            if len(flag)>1:
                test=flag[1]
            else:
                continue
            for i in self.check_list:
                if (test.upper().find(i.upper())!=-1):
                    print (test)
                    print (i)
                    return -1
        return 1        


